<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Smarthouse control</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png" />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="/apple-icon-114x114.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="/apple-icon-120x120.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="/apple-icon-144x144.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/apple-icon-152x152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/apple-icon-180x180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/android-icon-192x192.png"
    />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png" />
    <meta name="theme-color" content="#ffffff" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.css"
      integrity="sha512-/zs32ZEJh+/EO2N1b0PEdoA10JkdC3zJ8L5FTiQu82LR9S/rOQNfQN7U59U9BC12swNeRAz3HSzIL2vpp4fv3w=="
      crossorigin="anonymous"
    />

    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="bg-gray-600">
    <div class="container mx-auto min-h-screen p-5 md:p-10">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-10">
        <!-- status -->
        <div
          class="p-4 rounded-3xl md:col-span-2 bg-white text-center flex flex-col justify-center items-center"
        >
          <h1 class="text-5xl font-bold text-purple-700">SMARTHOUSE</h1>
          <h1 class="text-2xl font-bold mt-5">Trạng thái:</h1>
          <p
            id="status"
            class="uppercase font-bold bg-red-500 mt-3 p-4 text-white"
          >
            Không thể kết nối
          </p>
          <h1 class="text-2xl font-bold mt-5">Nhiệt độ:</h1>

          <div class="flex flex-wrap justify-center gap-5 mt-5 text-left">
            <div
              class="text-white font-bold p-4 rounded-3xl cursor-pointer transition-all duration-500 ease-in-out"
              id="temp_card_0"
              style="background-color: gray"
            >
              <div class="flex gap-5 justify-between">
                <h1>Phòng A</h1>
                <p class="text-blue-700"><span id="temp_value_0">30</span>°C</p>
              </div>
              <p id="temp_status_0" class="text-gray-200">Trạng thái 1</p>
            </div>
            <div
              class="text-white font-bold p-4 rounded-3xl cursor-pointer transition-all duration-500 ease-in-out"
              id="temp_card_1"
              style="background-color: gray"
            >
              <div class="flex gap-5 justify-between">
                <h1>Phòng B</h1>
                <p class="text-blue-700"><span id="temp_value_1">30</span>°C</p>
              </div>
              <p id="temp_status_1" class="text-gray-200">Trạng thái 1</p>
            </div>
            <div
              class="text-white font-bold p-4 rounded-3xl cursor-pointer transition-all duration-500 ease-in-out"
              id="temp_card_2"
              style="background-color: gray"
            >
              <div class="flex gap-5 justify-between">
                <h1>Phòng C</h1>
                <p class="text-blue-700"><span id="temp_value_2">30</span>°C</p>
              </div>
              <p id="temp_status_2" class="text-gray-200">Trạng thái 1</p>
            </div>
            <div
              class="text-white font-bold p-4 rounded-3xl cursor-pointer transition-all duration-500 ease-in-out"
              id="temp_card_3"
              style="background-color: gray"
            >
              <div class="flex gap-5 justify-between">
                <h1>Phòng D</h1>
                <p class="text-blue-700"><span id="temp_value_3">30</span>°C</p>
              </div>
              <p id="temp_status_3" class="text-gray-200">Trạng thái 1</p>
            </div>
          </div>
        </div>
        <!-- dieu khien  -->
        <div
          class="flex flex-col justify-center items-center p-4 md:col-span-2 rounded-3xl bg-white text-center"
        >
          <h1 class="text-xl font-bold">Điều khiển</h1>
          <div
            class="grid grid-cols-3 md:grid-cols-4 gap-4 p-4 justify-center items-center mt-5"
          >
            <div
              class="bg-blue-400 col-span-3 md:col-span-2 h-full w-full p-4 rounded-3xl transition-all duration-75 ease-in-out"
            >
              <h1
                class="font-bold text-white text-xl flex justify-between items-center"
              >
                Điều khiển nhiệt độ
                <span
                  class="px-2 py-1 rounded-xl cursor-pointer"
                  onclick="temp_control_toggle()"
                  id="temp_control_enable"
                  >Tắt</span
                >
              </h1>
              <div
                class="mt-2 border-blue-900 border-8 w-32 rounded-full h-32 mx-auto flex justify-center items-center"
              >
                <h2
                  id="temp_control_value"
                  class="text-5xl font-bold text-blue-100"
                >
                  30
                </h2>
              </div>
              <div
                class="flex mt-5 items-center justify-evenly text-xl text-white"
              >
                <div
                  onclick="temp_control_value(-1)"
                  class="px-4 py-2 bg-purple-300 rounded-2xl font-bold cursor-pointer"
                >
                  Giảm
                </div>
                <div
                  onclick="temp_control_value(1)"
                  class="px-4 py-2 bg-purple-300 rounded-2xl font-bold cursor-pointer"
                >
                  Tăng
                </div>
              </div>
            </div>
            <div
              onclick="door(false)"
              class="bg-red-700 p-4 w-full h-full flex justify-center flex-col rounded-3xl cursor-pointer transition-all duration-75 ease-in-out"
            >
              <img class="p-1 text-white" src="door2.svg" />
              <h1 class="font-bold text-white">Đóng cửa</h1>
            </div>
            <div
              onclick="door(true)"
              class="bg-green-700 p-4 h-full w-full flex justify-center flex-col rounded-3xl cursor-pointer transition-all duration-75 ease-in-out"
            >
              <img class="p-1 text-white" src="door1.svg" />
              <h1 class="font-bold text-white">Mở cửa</h1>
            </div>
            <div
              onclick="lightToggle(5)"
              id="GPIO5"
              data-state="0"
              class="bg-gray-400 p-4 h-full w-full rounded-3xl cursor-pointer transition-all duration-75 ease-in-out"
            >
              <img class="p-1 text-white" src="lightbulb.svg" />
              <h1 class="font-bold text-white">Đèn 2</h1>
            </div>
            <div
              onclick="lightToggle(25)"
              id="GPIO25"
              data-state="0"
              class="bg-gray-400 p-4 h-full w-full rounded-3xl cursor-pointer transition-all duration-75 ease-in-out"
            >
              <img class="p-1 text-white" src="lightbulb.svg" />
              <h1 class="font-bold text-white">Đèn 1</h1>
            </div>
            <div
              onclick="lightToggle(12)"
              id="GPIO12"
              data-state="0"
              class="bg-gray-400 p-4 rounded-3xl h-full w-full cursor-pointer transition-all duration-75 ease-in-out"
            >
              <img class="p-1 text-white" src="switch.svg" />
              <h1 class="font-bold text-white">Sò</h1>
            </div>
            <div
              onclick="lightToggle(17)"
              id="GPIO17"
              exportparts="0"
              class="bg-gray-400 p-4 rounded-3xl h-full w-full cursor-pointer transition-all duration-75 ease-in-out"
            >
              <img class="p-1 text-white" src="switch.svg" />
              <h1 class="font-bold text-white">Motor</h1>
            </div>

            <div
              onclick="lightToggle(27)"
              data-state="0"
              id="GPIO27"
              class="bg-gray-400 p-4 rounded-3xl h-full w-full cursor-pointer transition-all duration-75 ease-in-out"
            >
              <img class="p-1 text-white" src="switch.svg" />
              <h1 class="font-bold text-white">Quạt sò</h1>
            </div>
            <div
              onclick="lightToggle(6)"
              data-state="0"
              id="GPIO6"
              class="bg-gray-400 p-4 rounded-3xl h-full w-full cursor-pointer transition-all duration-75 ease-in-out"
            >
              <img class="p-1 text-white" src="switch.svg" />
              <h1 class="font-bold text-white">Đèn sưởi</h1>
            </div>
          </div>
        </div>
        <!-- this is fucking chart -->
        <div
          class="md:col-span-2 p-4 rounded-3xl bg-white relative text-center"
        >
          <h1 class="text-xl font-bold">
            Biểu đồ nhiệt thời gian thực phòng A
          </h1>
          <p class="text-blue-600 font-bold text-2xl">
            <span id="temp_0">30</span>°C
          </p>
          <canvas id="canvas"></canvas>
        </div>
        <!-- this is fucking chart 2 -->
        <div
          class="md:col-span-2 p-4 rounded-3xl bg-white relative text-center"
        >
          <h1 class="text-xl font-bold">
            Biểu đồ nhiệt thời gian thực phòng B
          </h1>
          <p class="text-blue-600 font-bold text-2xl">
            <span id="temp_1">30</span>°C
          </p>
          <canvas id="canvas2"></canvas>
        </div>
        <div
          class="md:col-span-2 p-4 rounded-3xl bg-white relative text-center"
        >
          <h1 class="text-xl font-bold">
            Biểu đồ nhiệt thời gian thực phòng C
          </h1>
          <p class="text-blue-600 font-bold text-2xl">
            <span id="temp_2">30</span>°C
          </p>
          <canvas id="canvas3"></canvas>
        </div>
        <div
          class="md:col-span-2 p-4 rounded-3xl bg-white relative text-center"
        >
          <h1 class="text-xl font-bold">
            Biểu đồ nhiệt thời gian thực phòng D
          </h1>
          <p class="text-blue-600 font-bold text-2xl">
            <span id="temp_3">30</span>°C
          </p>
          <canvas id="canvas4"></canvas>
        </div>

        <!-- this is chart with magic -->
        <div
          class="md:col-span-2 p-4 rounded-3xl bg-white relative text-center"
        >
          <h1 class="text-2xl font-bold">Thống kê nhiệt độ</h1>
          <p class="font-bold text-xl">
            Nhiệt độ trung bình:
            <span class="text-blue-600">
              <span id="query_temp">-</span>°C
            </span>
          </p>
          <form
            id="temp_data"
            class="flex flex-wrap gap-5 justify-center items-center"
          >
            <div class="flex-1">
              <label for="type">Theo</label>
              <select name="type" id="type" class="border-2">
                <option value="second">Giây</option>
                <option value="minute" selected>Phút</option>
                <option value="hour">Giờ</option>
                <option value="day">Ngày</option>
                <option value="month">Tháng</option>
              </select>
              <br />
              <label for="room_id">Phòng</label>
              <select name="room_id" id="room_id" class="border-2">
                <option value="0">A</option>
                <option value="1" selected>B</option>
                <option value="2">C</option>
                <option value="3">D</option>
              </select>
            </div>
            <div class="flex-1">
              <label for="start_date">Ngày bắt đầu: </label>
              <input
                required
                type="datetime-local"
                name="start_date"
                id="start_date"
                class="border-2"
              />
            </div>
            <div class="flex-1">
              <label for="end_date">Ngày kết thúc: </label>
              <input
                required
                type="datetime-local"
                name="end_date"
                id="end_date"
                class="border-2"
              />
            </div>
            <button
              type="submit"
              class="px-4 py-2 bg-green-400 rounded text-white font-bold"
            >
              Xem thống kê
            </button>
          </form>
          <canvas id="canvas_query"></canvas>
        </div>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.js"
      integrity="sha512-zO8oeHCxetPn1Hd9PdDleg5Tw1bAaP0YmNvPY8CwcRyUk7d7/+nyElmFrB6f7vg4f7Fv4sui1mcep8RIEShczg=="
      crossorigin="anonymous"
    ></script>
    <script>
      let socket = io("", { query: "name=website" });
      function boardConnect(isConnected) {
        if (isConnected) {
          $("#status").addClass("bg-green-500");
          $("#status").removeClass("bg-red-500");
          $("#status").text("Đã kết nối");
        } else {
          $("#status").addClass("bg-red-500");
          $("#status").removeClass("bg-green-500");
          $("#status").text("Không thể kết nối");
        }
      }
      function addData(chart, label, data) {
        chart.data.labels.push(label);
        chart.data.datasets.forEach((dataset) => {
          dataset.data.push(data);
        });
        if (chart.data.labels.length > 20) removeData(chart);
        chart.update();
      }
      function replaceData(chart, labels, data) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
      }
      function removeData(chart) {
        chart.data.labels.shift();
        chart.data.datasets.forEach((dataset) => {
          dataset.data.shift();
        });
        chart.update();
      }
      function createChart(id) {
        let config = {
          type: "line",
          data: {
            datasets: [
              {
                backgroundColor: "blue",
                borderColor: "blue",
                fill: false,
                label: "Nhiet do",
                data: [],
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              xAxes: [
                {
                  type: "time",
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: "Date",
                  },
                  ticks: {
                    major: {
                      fontStyle: "bold",
                      fontColor: "#FF0000",
                    },
                  },
                },
              ],
              yAxes: [
                {
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: "Độ C",
                  },
                },
              ],
            },
          },
        };
        return new Chart(document.getElementById(id).getContext("2d"), config);
      }
      function lightToggleColor(e, id) {
        let state = e.data("state");
        e.data("state", state ? 0 : 1);
        if (state == 1) {
          e.removeClass("bg-yellow-400");
          e.addClass("bg-gray-400");
        } else {
          e.addClass("bg-yellow-400");
          e.removeClass("bg-gray-400");
        }
      }
      function lightToggle(id) {
        let e = $("#GPIO" + id);
        let state = e.data("state");
        socket.emit("GPIO_control", {
          GPIO: id,
          state: state ? 0 : 1,
        });
      }
      function door(state) {
        socket.emit("door", { state });
      }
      function temp_control_value(value) {
        socket.emit("temp_control_value", value);
      }
      function temp_control_toggle() {
        socket.emit("temp_control_toggle");
      }
      let temp_graph_1 = createChart("canvas");
      let temp_graph_2 = createChart("canvas2");
      let temp_graph_3 = createChart("canvas3");
      let temp_graph_4 = createChart("canvas4");
      let graph = [temp_graph_1, temp_graph_2, temp_graph_3, temp_graph_4];
      let query_graph = createChart("canvas_query");
      $("#GPIO_control").on("submit", function (e) {
        e.preventDefault();
        let raw_data = $("#GPIO_control").serializeArray();
        let data = {};
        raw_data.forEach((element) => {
          data[element.name] = element.value;
        });
        socket.emit("GPIO_control", data);
      });
      $("#temp_data").on("submit", function (e) {
        e.preventDefault();
        let raw_data = $("#temp_data").serializeArray();
        let data = {};
        raw_data.forEach((element) => {
          data[element.name] = element.value;
        });
        socket.emit("temp_data", data);
      });
      socket.on("board_data", (data) => {
        boardConnect(data.boardIsConnected);

        let temp_control = data.temp_control;
        $("#temp_control_value").html(temp_control.value);
        let temp_control_enable = temp_control.enable;
        if (temp_control_enable) {
          $("#temp_control_enable").html("Tắt");
          $("#temp_control_enable").removeClass("bg-green-400");
          $("#temp_control_enable").addClass("bg-red-400");
        } else {
          $("#temp_control_enable").html("Bật");
          $("#temp_control_enable").removeClass("bg-red-400");
          $("#temp_control_enable").addClass("bg-green-400");
        }
        let GPIO = data.data.GPIO;
        for (let relay in GPIO) {
          let e = $("#GPIO" + relay);
          if (e.data("state") != GPIO[relay]) lightToggleColor(e, relay);
        }

        let status = [
          "Nhiệt độ bình thường",
          "Nhiệt độ bất thường",
          "Nhiệt độ nguy hiểm",
        ];
        for (let i in data.temp) {
          let temp = data.temp[i];
          $("#temp_card_" + i).css(
            "background-color",
            temp.status == 2
              ? "#ef4444"
              : temp.status == 1
              ? "#f59e0b"
              : "#10b981"
          );
          $("#temp_value_" + i).html(Math.floor(temp.value, 2));
          $("#temp_status_" + i).html(status[temp.status]);
        }
      });
      socket.on("temp_sensor", (data) => {
        let g = graph[data.id];
        addData(g, data.date, data.value);
        $("#temp_" + data.id).text(data.value.toFixed(2));
      });
      socket.on("temp_data", (payload) => {
        let labels = [];
        let data = [];
        let totalTemp = 0;
        for (let e of payload) {
          labels.push(e.date);
          data.push(e.value);
          totalTemp += e.value;
        }
        replaceData(query_graph, labels, data);
        $("#query_temp").text((totalTemp / data.length).toFixed(2));
      });
    </script>
  </body>
</html>
