<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Smarthouse control</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png" />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="/apple-icon-114x114.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="/apple-icon-120x120.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="/apple-icon-144x144.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/apple-icon-152x152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/apple-icon-180x180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/android-icon-192x192.png"
    />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png" />
    <meta name="theme-color" content="#ffffff" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.css"
      integrity="sha512-/zs32ZEJh+/EO2N1b0PEdoA10JkdC3zJ8L5FTiQu82LR9S/rOQNfQN7U59U9BC12swNeRAz3HSzIL2vpp4fv3w=="
      crossorigin="anonymous"
    />

    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="bg-gray-600">
    <div class="container mx-auto min-h-screen p-5 md:p-10">
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-10">
        <div
          class="p-4 rounded-3xl bg-white text-center flex flex-col justify-center items-center"
        >
          <h1 class="text-xl font-bold">Trạng thái mạch</h1>
          <p
            id="status"
            class="uppercase font-bold bg-red-500 mt-3 p-4 text-white"
          >
            Không thể kết nối
          </p>
        </div>
        <div
          class="row-start-2 p-4 rounded-3xl bg-white text-center flex flex-col justify-center items-center"
        >
          <h1 class="text-xl font-bold">Điều khiển chân</h1>
          <form
            id="GPIO_control"
            class="flex flex-col gap-4 mt-5 justify-center"
          >
            <div>
              <span>Cổng GPIO: </span>
              <input
                class="border text-center"
                type="number"
                name="GPIO"
                min="0"
                max="50"
                value="0"
              />
            </div>
            <div>
              <span>Trạng thái: </span>
              <input
                class="border text-center"
                type="number"
                name="state"
                min="0"
                max="1"
                value="0"
              />
            </div>
            <button
              class="bg-green-500 rounded-md px-4 py-2 font-bold text-white"
              type="submit"
            >
              Send
            </button>
          </form>
        </div>
        <!-- this is fucking chart -->
        <div
          class="md:col-span-2 p-4 rounded-3xl bg-white relative text-center"
        >
          <h1 class="text-xl font-bold">
            Biểu đồ nhiệt thời gian thực phòng A
          </h1>
          <p class="text-blue-600 font-bold text-2xl">
            <span id="temp_1">30</span>°C
          </p>
          <canvas id="canvas"></canvas>
        </div>
        <!-- this is fucking chart 2 -->
        <div
          class="md:col-span-2 p-4 rounded-3xl bg-white relative text-center"
        >
          <h1 class="text-xl font-bold">
            Biểu đồ nhiệt thời gian thực phòng B
          </h1>
          <p class="text-blue-600 font-bold text-2xl">
            <span id="temp_2">30</span>°C
          </p>
          <canvas id="canvas2"></canvas>
        </div>
        <div
          class="md:col-span-2 p-4 rounded-3xl bg-white relative text-center"
        >
          <h1 class="text-xl font-bold">
            Biểu đồ nhiệt thời gian thực phòng C
          </h1>
          <p class="text-blue-600 font-bold text-2xl">
            <span id="temp_3">30</span>°C
          </p>
          <canvas id="canvas3"></canvas>
        </div>
        <div
          class="md:col-span-2 p-4 rounded-3xl bg-white relative text-center"
        >
          <h1 class="text-xl font-bold">
            Biểu đồ nhiệt thời gian thực phòng D
          </h1>
          <p class="text-blue-600 font-bold text-2xl">
            <span id="temp_4">30</span>°C
          </p>
          <canvas id="canvas4"></canvas>
        </div>
        <div
          class="p-4 md:col-span-2 row-span-2 rounded-3xl bg-white text-center"
        >
          <h1 class="text-xl font-bold">Điều khiển đèn</h1>
          <div class="flex flex-wrap justify-center items-center gap-6 mt-5">
            <div
              onclick="lightToggle(this,1)"
              data-state="1"
              class="bg-yellow-400 p-4 rounded-3xl cursor-pointer transition-all duration-500 ease-in-out"
            >
              <img class="p-1 text-white" src="lightbulb.svg" />
              <h1 class="font-bold text-white">Đèn 1</h1>
            </div>
            <div
              onclick="lightToggle(this,2)"
              data-state="0"
              class="bg-gray-400 p-4 rounded-3xl cursor-pointer transition-all duration-500 ease-in-out"
            >
              <img class="p-1 text-white" src="lightbulb.svg" />
              <h1 class="font-bold text-white">Đèn 2</h1>
            </div>
            <div
              onclick="lightToggle(this,3)"
              data-state="1"
              class="bg-yellow-400 p-4 rounded-3xl cursor-pointer transition-all duration-500 ease-in-out"
            >
              <img class="p-1 text-white" src="lightbulb.svg" />
              <h1 class="font-bold text-white">Đèn 3</h1>
            </div>
            <div
              onclick="lightToggle(this,4)"
              data-state="0"
              class="bg-gray-400 p-4 rounded-3xl cursor-pointer transition-all duration-500 ease-in-out"
            >
              <img class="p-1 text-white" src="lightbulb.svg" />
              <h1 class="font-bold text-white">Đèn 4</h1>
            </div>
            <div
              onclick="lightToggle(this,5)"
              data-state="1"
              class="bg-yellow-400 p-4 rounded-3xl cursor-pointer transition-all duration-500 ease-in-out"
            >
              <img class="p-1 text-white" src="lightbulb.svg" />
              <h1 class="font-bold text-white">Đèn 5</h1>
            </div>
          </div>
        </div>
        <!-- this is chart with magic -->
        <div
          class="md:col-span-3 p-4 rounded-3xl bg-white relative text-center"
        >
          <h1 class="text-2xl font-bold">Thống kê nhiệt độ</h1>
          <p class="font-bold text-xl">
            Nhiệt độ trung bình:
            <span class="text-blue-600">
              <span id="query_temp">-</span>°C
            </span>
          </p>
          <form
            id="temp_data"
            class="flex flex-wrap gap-5 justify-center items-center"
          >
            <div class="flex-1">
              <label for="type">Theo</label>
              <select name="type" id="type" class="border-2">
                <option value="second">Giây</option>
                <option value="minute" selected>Phút</option>
                <option value="hour">Giờ</option>
                <option value="day">Ngày</option>
                <option value="month">Tháng</option>
              </select>
              <br />
              <label for="room_id">Phòng</label>
              <select name="room_id" id="room_id" class="border-2">
                <option value="1">A</option>
                <option value="2" selected>B</option>
                <option value="3">C</option>
                <option value="4">D</option>
              </select>
            </div>
            <div class="flex-1">
              <label for="start_date">Ngày bắt đầu: </label>
              <input
                required
                type="datetime-local"
                name="start_date"
                id="start_date"
                class="border-2"
              />
            </div>
            <div class="flex-1">
              <label for="end_date">Ngày kết thúc: </label>
              <input
                required
                type="datetime-local"
                name="end_date"
                id="end_date"
                class="border-2"
              />
            </div>
            <button
              type="submit"
              class="px-4 py-2 bg-green-400 rounded text-white font-bold"
            >
              Xem thống kê
            </button>
          </form>
          <canvas id="canvas_query"></canvas>
        </div>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.js"
      integrity="sha512-zO8oeHCxetPn1Hd9PdDleg5Tw1bAaP0YmNvPY8CwcRyUk7d7/+nyElmFrB6f7vg4f7Fv4sui1mcep8RIEShczg=="
      crossorigin="anonymous"
    ></script>
    <script>
      let socket = io("", { query: "name=website" });
      function boardConnect(isConnected) {
        if (isConnected) {
          $("#status").addClass("bg-green-500");
          $("#status").removeClass("bg-red-500");
          $("#status").text("Đã kết nối");
        } else {
          $("#status").addClass("bg-red-500");
          $("#status").removeClass("bg-green-500");
          $("#status").text("Không thể kết nối");
        }
      }
      function addData(chart, label, data) {
        chart.data.labels.push(label);
        chart.data.datasets.forEach((dataset) => {
          dataset.data.push(data);
        });
        if (chart.data.labels.length > 20) removeData(chart);
        chart.update();
      }
      function replaceData(chart, labels, data) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
      }
      function removeData(chart) {
        chart.data.labels.shift();
        chart.data.datasets.forEach((dataset) => {
          dataset.data.shift();
        });
        chart.update();
      }
      function createChart(id) {
        let config = {
          type: "line",
          data: {
            datasets: [
              {
                backgroundColor: "blue",
                borderColor: "blue",
                fill: false,
                label: "Nhiet do",
                data: [],
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              xAxes: [
                {
                  type: "time",
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: "Date",
                  },
                  ticks: {
                    major: {
                      fontStyle: "bold",
                      fontColor: "#FF0000",
                    },
                  },
                },
              ],
              yAxes: [
                {
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: "Độ C",
                  },
                },
              ],
            },
          },
        };
        return new Chart(document.getElementById(id).getContext("2d"), config);
      }
      function lightToggle(e, id) {
        let state = $(e).data("state");
        $(e).data("state", state ? 0 : 1);
        if (state == 1) {
          $(e).removeClass("bg-yellow-400");
          $(e).addClass("bg-gray-400");
        } else {
          $(e).addClass("bg-yellow-400");
          $(e).removeClass("bg-gray-400");
        }
        socket.emit("GPIO_control", {
          GPIO: "bulb:" + id,
          state: state ? 0 : 1,
        });
      }
      let temp_graph_1 = createChart("canvas");
      let temp_graph_2 = createChart("canvas2");
      let temp_graph_3 = createChart("canvas3");
      let temp_graph_4 = createChart("canvas4");
      let query_graph = createChart("canvas_query");
      $("#GPIO_control").on("submit", function (e) {
        e.preventDefault();
        let raw_data = $("#GPIO_control").serializeArray();
        let data = {};
        raw_data.forEach((element) => {
          data[element.name] = element.value;
        });
        socket.emit("GPIO_control", data);
      });
      $("#temp_data").on("submit", function (e) {
        e.preventDefault();
        let raw_data = $("#temp_data").serializeArray();
        let data = {};
        raw_data.forEach((element) => {
          data[element.name] = element.value;
        });
        socket.emit("temp_data", data);
      });
      socket.on("board_data", (data) => {
        boardConnect(data.boardIsConnected);
      });
      socket.on("temp_sensor", (data) => {
        addData(temp_graph_1, data[0].date, data[0].value);
        $("#temp_1").text(data[0].value.toFixed(2));
        addData(temp_graph_2, data[1].date, data[1].value);
        $("#temp_2").text(data[1].value.toFixed(2));
        addData(temp_graph_3, data[2].date, data[2].value);
        $("#temp_3").text(data[2].value.toFixed(2));
        addData(temp_graph_4, data[3].date, data[3].value);
        $("#temp_4").text(data[3].value.toFixed(2));
      });
      socket.on("temp_data", (payload) => {
        let labels = [];
        let data = [];
        let totalTemp = 0;
        for (let e of payload) {
          labels.push(e.date);
          data.push(e.value);
          totalTemp += e.value;
        }
        console.log(payload);
        replaceData(query_graph, labels, data);
        $("#query_temp").text((totalTemp / data.length).toFixed(2));
      });
    </script>
  </body>
</html>
